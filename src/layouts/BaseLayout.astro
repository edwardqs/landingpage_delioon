---
// src/layouts/BaseLayout.astro
import Topbar from '../components/Topbar.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';

interface Props {
	title: string;
	showFooter?: boolean;
}

const { title, showFooter = true } = Astro.props;
---
<!doctype html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{title}</title>
		
		<!-- Meta tags de rendimiento -->
		<meta name="description" content="Delion - Soluciones innovadoras y sostenibles para potenciar tu negocio con tecnología de vanguardia." />
		<meta name="keywords" content="Delion, tecnología, innovación, soluciones, minería, software, hardware" />
		<meta name="author" content="Delion Perú" />
		
		<!-- Preload de recursos críticos -->
		<link rel="preload" href="/logo_delion.png" as="image" type="image/png" />
		<link rel="preload" href="/src/styles/global.css" as="style" />
		
		<!-- DNS prefetch para recursos externos -->
		<link rel="dns-prefetch" href="//www.google.com" />
		<link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
		<link rel="dns-prefetch" href="//wa.me" />
		
		<!-- Preconnect para conexiones críticas -->
		<link rel="preconnect" href="https://www.google.com" crossorigin />
		<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
		<link rel="preconnect" href="https://wa.me" crossorigin />
		
		<!-- Favicon optimizado -->
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" type="image/png" href="/logo_delion.png" />
		
		<!-- Open Graph para redes sociales -->
		<meta property="og:title" content={title} />
		<meta property="og:description" content="Delion - El Arte de la Ciencia" />
		<meta property="og:type" content="website" />
		<meta property="og:url" content={Astro.url} />
		<meta property="og:image" content="/logo_delion.png" />
		
		<!-- Twitter Card -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content="Delion - El Arte de la Ciencia" />
		<meta name="twitter:image" content="/logo_delion.png" />
		
		<!-- Performance hints -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="format-detection" content="telephone=no" />
		
		<!-- Optimizaciones de rendimiento -->
		<meta name="theme-color" content="#0C3C6F" />
		<meta name="color-scheme" content="light dark" />
		
		<!-- Preload de fuentes críticas -->
		<link rel="preload" href="data:font/woff2;base64,d09GMgABAAAAAA..." as="font" type="font/woff2" crossorigin />
		
		<!-- Resource hints para mejor rendimiento -->
		<link rel="dns-prefetch" href="//fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		
		<!-- Critical CSS inline -->
		<style is:inline>
			/* Estilos críticos para el primer render */
			body { 
				margin: 0; 
				font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				text-rendering: optimizeSpeed;
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
			}
			
			.animate-fade-in { 
				opacity: 0; 
				animation: fadeIn 0.5s ease-out forwards;
				will-change: opacity;
			}
			
			@keyframes fadeIn { 
				to { opacity: 1; } 
			}
			
			/* Estilos optimizados para el botón de WhatsApp */
			#whatsapp-button {
				opacity: 0;
				transform: translateY(20px);
				transition: opacity 0.6s ease-out, transform 0.6s ease-out;
				will-change: transform, opacity;
			}
			
			#whatsapp-button.visible {
				opacity: 1;
				transform: translateY(0);
			}
			
			#whatsapp-button:hover {
				transform: scale(1.05);
			}
			
			/* Efecto de pulso optimizado */
			#whatsapp-button::before {
				content: '';
				position: absolute;
				top: -2px;
				left: -2px;
				right: -2px;
				bottom: -2px;
				background: rgba(34, 197, 94, 0.2);
				border-radius: 50%;
				opacity: 0;
				transition: opacity 0.3s ease;
				z-index: -1;
			}
			
			#whatsapp-button:hover::before {
				opacity: 1;
			}
			
			/* Responsive optimizado */
			@media (max-width: 768px) {
				#whatsapp-button {
					bottom: 1rem;
					right: 1rem;
					width: 3.5rem;
					height: 3.5rem;
				}
				
				#whatsapp-button svg {
					width: 24px;
					height: 24px;
				}
			}
			
			/* Optimizaciones de rendimiento */
			* {
				box-sizing: border-box;
			}
			
			/* Reducir repaints en scroll */
			html {
				scroll-behavior: smooth;
			}
			
			/* Optimizar transiciones */
			.transition-optimized {
				transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
				will-change: transform, opacity;
			}
		</style>
	</head>
	<body>
        <header class="sticky top-0 left-0 w-full z-50">
            <Topbar />
            <Navbar />
        </header>

        <slot />

        {showFooter && <Footer />}
        
        <!-- Botón flotante de WhatsApp -->
        <div id="whatsapp-button" class="fixed bottom-6 right-6 z-50 group">
            <!-- Tooltip optimizado -->
            <div class="absolute bottom-full right-0 mb-3 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none transition-optimized">
                ¡Chatea con nosotros!
                <div class="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
            </div>
            
            <a 
                href="https://wa.me/51913851514?text=Hola%20Delion,%20me%20gustaría%20obtener%20más%20información%20sobre%20sus%20productos%20y%20servicios." 
                target="_blank" 
                rel="noopener noreferrer"
                class="flex items-center justify-center w-16 h-16 bg-green-500 hover:bg-green-600 text-white rounded-full shadow-lg hover:shadow-xl transition-optimized group/btn"
                aria-label="Contactar por WhatsApp"
                title="Contactar por WhatsApp"
            >
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width="28" 
                    height="28" 
                    viewBox="0 0 24 24" 
                    fill="currentColor"
                    class="group-hover/btn:rotate-6 transition-optimized"
                    aria-hidden="true"
                >
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                </svg>
            </a>
        </div>
        
        <script>
            // Script optimizado para el botón de WhatsApp
            (function() {
                'use strict';
                
                function initWhatsAppButton() {
                    const whatsappButton = document.getElementById('whatsapp-button');
                    
                    if (!whatsappButton) return;
                    
                    // Usar Intersection Observer para lazy loading
                    if ('IntersectionObserver' in window) {
                        const observer = new IntersectionObserver(function(entries) {
                            entries.forEach(function(entry) {
                                if (entry.isIntersecting) {
                                    // Mostrar botón cuando sea visible
                                    whatsappButton.classList.add('visible');
                                    observer.unobserve(whatsappButton);
                                }
                            });
                        }, {
                            threshold: 0.1,
                            rootMargin: '50px'
                        });
                        
                        observer.observe(whatsappButton);
                    }
                    
                    // Fallback: mostrar después de 1.5 segundos
                    setTimeout(function() {
                        if (!whatsappButton.classList.contains('visible')) {
                            whatsappButton.classList.add('visible');
                        }
                    }, 1500);
                }
                
                // Inicializar cuando el DOM esté listo
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initWhatsAppButton);
                } else {
                    initWhatsAppButton();
                }
            })();
        </script>
        
        <!-- Script de optimización de rendimiento -->
        <script>
            // Optimizaciones de rendimiento
            (function() {
                'use strict';
                
                // Lazy loading de imágenes
                if ('IntersectionObserver' in window) {
                    const imageObserver = new IntersectionObserver(function(entries, observer) {
                        entries.forEach(function(entry) {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                if (img instanceof HTMLImageElement && img.dataset.src) {
                                    img.src = img.dataset.src;
                                    img.classList.remove('lazy');
                                    observer.unobserve(img);
                                }
                            }
                        });
                    });
                    
                    document.querySelectorAll('img[data-src]').forEach(function(img) {
                        imageObserver.observe(img);
                    });
                }
                
                // Optimizar scroll performance
                let ticking = false;
                function updateOnScroll() {
                    if (!ticking) {
                        requestAnimationFrame(function() {
                            // Aquí puedes agregar lógica de scroll si es necesaria
                            ticking = false;
                        });
                        ticking = true;
                    }
                }
                
                // Usar passive listeners para mejor rendimiento
                window.addEventListener('scroll', updateOnScroll, { passive: true });
                window.addEventListener('resize', updateOnScroll, { passive: true });
                
                // Preload de recursos críticos
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', function() {
                        navigator.serviceWorker.register('/sw.js').catch(function() {
                            // Fallback silencioso
                        });
                    });
                }
            })();
        </script>
	</body>
</html>